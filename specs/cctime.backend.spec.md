
# Назначение

Данный файл описывает спецификацию backend программы для управления расписанием занятости специалистов по времени и кабинетам.

# Архитектура

Серверная сторона .NET Core 10. СУБД PostgreSQL. Развертывание в Linux/Docker.
При многопользовательской работе изменения в расписании одним пользователем должны синхронизироваться у другого пользователя (WebSocket). Нагрузка на систему мизерная: 10 запросов в час, клиентов до 100, специалистов до 25, одновременных пользователей до 10.

# Таблицы БД

specialists:
- id (UUID)
- name
- order_index (INTEGER, NOT NULL, default 0)
- is_archived (BOOLEAN, NOT NULL, default false)

clients:
- id (UUID)
- name
- order_index (INTEGER, NOT NULL, default 0)
- is_archived (BOOLEAN, NOT NULL, default false)

rooms:
- id (UUID)
- name
- order_index (INTEGER, NOT NULL, default 0)

time_slots:
- id (UUID)
- name
- type: (string: work|break)
- order_index (INTEGER, NOT NULL, default 0)

reserves:
- id (UUID)
- client_id (UUID, NOT NULL, default `00000000-0000-0000-0000-000000000001`)
- specialist_id (UUID, NOT NULL, default `00000000-0000-0000-0000-000000000001`)
- room_id (UUID, NOT NULL)
- date (DATE, NOT NULL)
- time_slot_id (UUID, NOT NULL)
- client_confirmed (BOOLEAN, NOT NULL, default false)
- specialist_confirmed (BOOLEAN, NOT NULL, default false)
- UNIQUE (date, time_slot_id, room_id)


# Операции API

## GetReferencesQuery

в конфигурации передаются сразу все значения без фильтрации
- specialists (только не архивные, `is_archived = false`)
- clients (только не архивные, `is_archived = false`)
- rooms
- timeSlots

## GetReservesForDate

формируется массив резервов на запрошенную дату

## SaveReserve

обновляется текущий резерв (если указан ID) или создаётся новый (если ID = null) и выполняется тиражирование на будущие недели.

**Тиражирование специалиста и клиента обрабатывается независимо:**
- Если для специалиста указано количество N, создаются (или обновляются) резервы на N следующих недель (тот же день недели, то же время, тот же кабинет) с этим специалистом.
- Если для клиента указано количество M, создаются (или обновляются) резервы на M следующих недель с этим клиентом.
- Если N ≠ M, то в неделях где тиражируется только один параметр, второй остаётся без изменений (или «свободно» для новых резервов).

**Проверка конфликтов при тиражировании:**
- Если в будущем резерве уже указан **другой** специалист (не совпадает с тиражируемым и не «свободно»), выводится предупреждение и сохранение не выполняется. Пользователь должен изменить количество на 1, чтобы сохранить только текущий резерв.
- Аналогично для клиента.
- Если в будущем резерве уже стоит **тот же** специалист/клиент — конфликта нет.

**Атомарность:** Операция сохранения выполняется в транзакции (all-or-nothing). Если при тиражировании обнаружен конфликт, вся операция откатывается. Ошибка должна содержать достаточно сведений для понимания причины: на какой дате конфликт, кто уже назначен.


## GetSpecialists

Возвращает полный список специалистов (включая архивных). Сортировка по `order_index`.

## SaveSpecialist

Создаёт нового специалиста (если `id = null`) или обновляет существующего (если `id` указан). Поля: `name`, `orderIndex`, `isArchived`. При создании генерируется новый UUID.

## GetClients

Возвращает полный список клиентов (включая архивных). Сортировка по `order_index`.

## SaveClient

Создаёт нового клиента (если `id = null`) или обновляет существующего (если `id` указан). Поля: `name`, `orderIndex`, `isArchived`. При создании генерируется новый UUID.

## Начальное наполнение данными

```json
{
    "specialists": [
        { "id": "00000000-0000-0000-0000-000000000001", "name": "-", "orderIndex": 0, "isArchived": false }
    ],
    "clients": [
        { "id": "00000000-0000-0000-0000-000000000001", "name": "-", "orderIndex": 0, "isArchived": false }
    ],
    "rooms": [
        { "id": "c3d4e5f6-0003-0000-0000-000000000001", "name": "ЛОГО", "orderIndex": 1 },
        { "id": "c3d4e5f6-0003-0000-0000-000000000002", "name": "НЕЙРО", "orderIndex": 2 }
    ],
    "timeSlots": [
        { "id": "d4e5f6a7-0004-0000-0000-000000000001", "name": "8.30-9.15", "type": "work", "orderIndex": 1 },
        { "id": "d4e5f6a7-0004-0000-0000-000000000002", "name": "9.15-10.00", "type": "work", "orderIndex": 2 },
        { "id": "d4e5f6a7-0004-0000-0000-000000000003", "name": "10.00-10.45", "type": "work", "orderIndex": 3 },
        { "id": "d4e5f6a7-0004-0000-0000-000000000004", "name": "перерыв 15 мин", "type": "break", "orderIndex": 4 },
        { "id": "d4e5f6a7-0004-0000-0000-000000000005", "name": "11.00-11.45", "type": "work", "orderIndex": 5 },
        { "id": "d4e5f6a7-0004-0000-0000-000000000006", "name": "11.45-12.30", "type": "work", "orderIndex": 6 },
        { "id": "d4e5f6a7-0004-0000-0000-000000000007", "name": "12.30-13.15", "type": "work", "orderIndex": 7 },
        { "id": "d4e5f6a7-0004-0000-0000-000000000008", "name": "обед", "type": "break", "orderIndex": 8 },
        { "id": "d4e5f6a7-0004-0000-0000-000000000009", "name": "13.30-14.15", "type": "work", "orderIndex": 9 },
        { "id": "d4e5f6a7-0004-0000-0000-000000000010", "name": "14.15-15.00", "type": "work", "orderIndex": 10 },
        { "id": "d4e5f6a7-0004-0000-0000-000000000011", "name": "15.00-15.45", "type": "work", "orderIndex": 11 },
        { "id": "d4e5f6a7-0004-0000-0000-000000000012", "name": "перерыв 15 мин", "type": "break", "orderIndex": 12 },
        { "id": "d4e5f6a7-0004-0000-0000-000000000013", "name": "16.00-16.45", "type": "work", "orderIndex": 13 },
        { "id": "d4e5f6a7-0004-0000-0000-000000000014", "name": "16.45-17.30", "type": "work", "orderIndex": 14 },
        { "id": "d4e5f6a7-0004-0000-0000-000000000015", "name": "17.30-18.15", "type": "work", "orderIndex": 15 },
        { "id": "d4e5f6a7-0004-0000-0000-000000000016", "name": "перерыв 15 мин", "type": "break", "orderIndex": 16 },
        { "id": "d4e5f6a7-0004-0000-0000-000000000017", "name": "18.30-19.15", "type": "work", "orderIndex": 17 },
        { "id": "d4e5f6a7-0004-0000-0000-000000000018", "name": "19.15-20.00", "type": "work", "orderIndex": 18 }
    ]
}
```
